import{aj as Y,d as Z,p as ee,r as N,i as te,aT as ae,b as F,o as T,f as o,w as r,c as ne,s as P,R as oe,e as y,aU as le,ao as re,B as se,h as I,g as d,t as c,x as ie,aP as D,G as ue}from"./index-Z8DUt18u.js";import{u as V}from"./echarts--HtOSnz8.js";import{_ as ce}from"./Alert-DUaZ8Sea.js";import{_ as de,a as fe}from"./DescriptionsItem-Hm123lMn.js";import{_ as me,a as pe}from"./Grid-tUpxGiRj.js";import{_ as _e}from"./Space-CCrTpFrl.js";function ve(){return Y({url:"/monitor/cache",method:"get"})}const he={class:"min-h-500px flex-col-stretch gap-16px overflow-y-auto lt-sm:overflow-auto"},ye={class:"flex flex-wrap items-center justify-between gap-y-12px"},be={class:"flex flex-wrap items-center gap-16px"},ge={class:"flex items-center gap-8px"},xe={key:0,class:"flex items-center gap-8px"},we=Z({name:"monitor_cache",__name:"index",setup(Se){const{loading:C,startLoading:W,endLoading:E}=ee(),u=N(),b=N(null),g=N(!1),B=N(30),R=N(null);async function M(){W(),b.value=null;try{const{error:a,data:s}=await ve();a?b.value="获取缓存信息失败":(u.value=s,D(()=>{J(),z()}))}catch{b.value="获取缓存信息出错"}finally{E()}}function K(){return M().then(()=>{D(()=>{j()})}).catch(()=>{D(()=>{u.value&&j()})})}function H(){g.value?O():L()}function O(){L(),R.value=setInterval(()=>{M()},B.value*1e3)}function L(){R.value&&(clearInterval(R.value),R.value=null)}function q(a){a!==null&&(B.value=a,g.value&&O())}const{domRef:k,updateOptions:A}=V(()=>({tooltip:{trigger:"item",formatter:"{a} <br/>{b} : {c} ({d}%)",backgroundColor:"rgba(255, 255, 255, 0.9)",borderColor:"#e6e6e6",borderWidth:1,textStyle:{color:"#666"},extraCssText:"box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);"},legend:{type:"scroll",orient:"vertical",right:10,top:20,bottom:20,textStyle:{color:"#666"}},series:[{name:"命令",type:"pie",roseType:"radius",radius:[15,95],center:["40%","50%"],data:[],animationEasing:"cubicInOut",animationDuration:1e3,itemStyle:{borderRadius:10,borderColor:"#fff",borderWidth:2},label:{formatter:"{b}: {d}%",color:"#666"},emphasis:{label:{show:!0,fontSize:"14",fontWeight:"bold"},itemStyle:{shadowBlur:10,shadowOffsetX:0,shadowColor:"rgba(0, 0, 0, 0.5)"}}}]})),{domRef:x,setOptions:X}=V(()=>({tooltip:{formatter:"内存使用情况"},series:[{name:"内存",type:"gauge",min:0,max:100,detail:{formatter:"{value}%",fontSize:16,fontWeight:"bold",offsetCenter:[0,"70%"]},data:[{value:0,name:"内存使用率"}],axisLine:{lineStyle:{width:8,color:[[.3,"#58d9f9"],[.7,"#26deca"],[1,"#ff8c6a"]]}},pointer:{itemStyle:{color:"auto"}},axisTick:{distance:-12,length:4,lineStyle:{color:"#999",width:1}},splitLine:{distance:-18,length:12,lineStyle:{color:"#999",width:1}},axisLabel:{color:"#666",distance:25,fontSize:12},title:{offsetCenter:[0,"90%"],fontSize:14},animationDuration:1e3}]}),{onRender:a=>{a.hideLoading()},onUpdated:a=>{a.hideLoading()}}),G=["#5da8ff","#8e9dff","#fedc69","#26deca","#ff8c6a","#58d9f9","#05c091","#7367f0","#9e86ff","#f8d3a5","#4a5bcc","#22bd7c"];function J(){if(u.value)try{A(a=>{var s;try{const f=((s=u.value)==null?void 0:s.commandStats)||[];if(!f.length)return a;const p=f.map(l=>{try{if(!l||typeof l!="object")return{name:"未知命令",value:0};if("name"in l&&"value"in l){const h=String(l.name);let v=0;try{v=Number.parseInt(String(l.value),10),Number.isNaN(v)&&(v=0)}catch{v=0}return{name:h,value:v}}const n=Object.keys(l)[0]||"未知命令";let i=0;try{i=Number.parseInt(String(Object.values(l)[0]||"0"),10),Number.isNaN(i)&&(i=0)}catch{i=0}return{name:n,value:i}}catch{return{name:"未知命令",value:0}}}).filter(l=>l.name!=="未知命令"||l.value>0);if(!p.length)return a;const _=p.sort((l,n)=>n.value-l.value);let m;if(_.length>10){const l=_.slice(0,10),i=_.slice(10).reduce((h,v)=>h+v.value,0);m=[...l,{name:"其他命令",value:i}]}else m=_;if(a.series&&Array.isArray(a.series)&&a.series[0]){a.series[0].data=m;const l={...a.series[0].itemStyle||{},color(n){const i=n.dataIndex%G.length;return G[i>=0?i:0]}};a.series[0].itemStyle=l,a.tooltip={...a.tooltip||{},formatter:function(i){if(!i||typeof i!="object")return"";const h=i.name||"未知命令",v=typeof i.value=="number"?i.value:0,$=typeof i.percent=="number"?i.percent:0;return`<div style="font-weight:bold;margin-bottom:5px;font-size:14px;">${h}</div><div>执行次数: <span style="font-weight:bold;float:right;">${v.toLocaleString()}</span></div><div>占比: <span style="font-weight:bold;float:right;">${$.toFixed(2)}%</span></div>`}}}return a}catch{return a}}),z()}catch{}}function z(){var a;try{const s=(a=u.value)==null?void 0:a.info;if(!s)return;const f=s,p=String(f.used_memory_human||"0B"),_=String(f.maxmemory_human||"0B"),m=U(p),l=U(_);let n=0;if(l.bytes>0)n=Math.min(100,Math.round(m.bytes/l.bytes*100));else if(f.total_system_memory)try{const h=Number(f.total_system_memory);h>0?n=Math.min(100,Math.round(m.bytes/h*100)):n=50}catch{n=50}else n=50;const i={tooltip:{formatter:l.bytes>0?`内存使用: ${p}<br/>最大内存: ${_}<br/>使用率: ${n}%`:`内存使用: ${p}<br/>最大内存: 未设置限制`},series:[{name:"内存",type:"gauge",min:0,max:100,detail:{formatter:l.bytes>0?"{value}%":p,fontSize:16,fontWeight:"bold",offsetCenter:[0,"70%"]},data:[{value:n,name:l.bytes>0?"内存使用率":"内存使用量"}],axisLine:{lineStyle:{width:8,color:[[.3,"#58d9f9"],[.7,"#26deca"],[1,"#ff8c6a"]]}},pointer:{itemStyle:{color:"auto"}},axisTick:{distance:-12,length:4,lineStyle:{color:"#999",width:1}},splitLine:{distance:-18,length:12,lineStyle:{color:"#999",width:1}},axisLabel:{color:"#666",distance:25,fontSize:12},title:{offsetCenter:[0,"90%"],fontSize:14},animationDuration:1e3}]};x.value&&X(i)}catch{}}function U(a){if(!a||typeof a!="string")return{value:0,unit:"B",bytes:0};try{const s=a.match(/^([\d.]+)([KMGTP]?B)?$/i);if(!s)return{value:0,unit:"B",bytes:0};const f=Number.parseFloat(s[1]),p=(s[2]||"B").toUpperCase(),_=["B","KB","MB","GB","TB","PB"].indexOf(p),m=_>=0?f*1024**_:f;return{value:f,unit:p,bytes:m}}catch{return{value:0,unit:"B",bytes:0}}}function j(){try{x.value&&z(),k.value&&A(a=>a)}catch{}}return te(async()=>{try{await M()}catch{b.value="初始化数据失败，请尝试刷新"}}),ae(()=>{L();try{k.value&&(k.value=null),x.value&&(x.value=null)}catch{}}),(a,s)=>{const f=le,p=re,_=se,m=oe,l=ce,n=fe,i=de,h=ie,v=pe,$=me,Q=_e;return T(),F("div",he,[o(Q,{vertical:"",size:16},{default:r(()=>[o(m,{bordered:!1,class:"control-panel card-wrapper"},{default:r(()=>[y("div",ye,[s[4]||(s[4]=y("h3",{class:"m-0 text-16px font-medium"},"Redis 缓存监控",-1)),y("div",be,[y("div",ge,[s[2]||(s[2]=y("span",{class:"whitespace-nowrap"},"自动刷新：",-1)),o(f,{value:g.value,"onUpdate:value":[s[0]||(s[0]=e=>g.value=e),H]},null,8,["value"])]),g.value?(T(),F("div",xe,[s[3]||(s[3]=y("span",{class:"whitespace-nowrap"},"间隔 (秒)：",-1)),o(p,{value:B.value,"onUpdate:value":[s[1]||(s[1]=e=>B.value=e),q],min:5,max:300,size:"small"},null,8,["value"])])):P("",!0),o(_,{type:"primary",loading:I(C),disabled:g.value,class:"min-w-80px",onClick:K},{default:r(()=>[d(c(I(C)?"刷新中...":"刷新数据"),1)]),_:1},8,["loading","disabled"])])])]),_:1}),b.value?(T(),ne(l,{key:0,type:"error",closable:""},{default:r(()=>[d(c(b.value),1)]),_:1})):P("",!0),o(m,{title:"Redis 基本信息",bordered:!1,class:"info-card card-wrapper"},{default:r(()=>[o(h,{show:I(C)},{default:r(()=>[o(i,{column:4,bordered:"","label-placement":"left","label-class":"w-150px"},{default:r(()=>[o(n,{label:"Redis 版本"},{default:r(()=>{var e,t;return[d(c((t=(e=u.value)==null?void 0:e.info)==null?void 0:t.redis_version),1)]}),_:1}),o(n,{label:"运行模式"},{default:r(()=>{var e,t;return[d(c(((t=(e=u.value)==null?void 0:e.info)==null?void 0:t.redis_mode)==="standalone"?"单机":"集群"),1)]}),_:1}),o(n,{label:"端口"},{default:r(()=>{var e,t;return[d(c((t=(e=u.value)==null?void 0:e.info)==null?void 0:t.tcp_port),1)]}),_:1}),o(n,{label:"客户端数"},{default:r(()=>{var e,t;return[d(c((t=(e=u.value)==null?void 0:e.info)==null?void 0:t.connected_clients),1)]}),_:1}),o(n,{label:"运行时间(天)"},{default:r(()=>{var e,t;return[d(c((t=(e=u.value)==null?void 0:e.info)==null?void 0:t.uptime_in_days),1)]}),_:1}),o(n,{label:"使用内存"},{default:r(()=>{var e,t;return[d(c((t=(e=u.value)==null?void 0:e.info)==null?void 0:t.used_memory_human),1)]}),_:1}),o(n,{label:"使用CPU"},{default:r(()=>{var e,t,w,S;return[d(c((t=(e=u.value)==null?void 0:e.info)!=null&&t.used_cpu_user_children?parseFloat((S=(w=u.value)==null?void 0:w.info)==null?void 0:S.used_cpu_user_children).toFixed(2):""),1)]}),_:1}),o(n,{label:"内存配置"},{default:r(()=>{var e,t;return[d(c((t=(e=u.value)==null?void 0:e.info)==null?void 0:t.maxmemory_human),1)]}),_:1}),o(n,{label:"AOF 开启"},{default:r(()=>{var e,t;return[d(c(((t=(e=u.value)==null?void 0:e.info)==null?void 0:t.aof_enabled)==="0"?"否":"是"),1)]}),_:1}),o(n,{label:"RDB 状态"},{default:r(()=>{var e,t;return[d(c((t=(e=u.value)==null?void 0:e.info)==null?void 0:t.rdb_last_bgsave_status),1)]}),_:1}),o(n,{label:"Key 数量"},{default:r(()=>{var e;return[d(c((e=u.value)==null?void 0:e.dbSize),1)]}),_:1}),o(n,{label:"网络入口/出口"},{default:r(()=>{var e,t,w,S;return[d(c((t=(e=u.value)==null?void 0:e.info)==null?void 0:t.instantaneous_input_kbps)+"kps/"+c((S=(w=u.value)==null?void 0:w.info)==null?void 0:S.instantaneous_output_kbps)+"kps ",1)]}),_:1})]),_:1})]),_:1},8,["show"])]),_:1}),o($,{cols:2,"x-gap":16,"y-gap":16,responsive:"screen","item-responsive":""},{default:r(()=>[o(v,{span:"0:24 1000:12"},{default:r(()=>[o(m,{title:"命令统计",bordered:!1,class:"chart-card card-wrapper"},{default:r(()=>[y("div",{ref_key:"commandChartRef",ref:k,class:"h-360px overflow-hidden"},null,512)]),_:1})]),_:1}),o(v,{span:"0:24 1000:12"},{default:r(()=>[o(m,{title:"内存信息",bordered:!1,class:"chart-card card-wrapper"},{default:r(()=>[o(h,{show:I(C)},{default:r(()=>[y("div",{ref_key:"memoryGaugeRef",ref:x,class:"h-360px overflow-hidden"},null,512)]),_:1},8,["show"])]),_:1})]),_:1})]),_:1})]),_:1})])}}}),Me=ue(we,[["__scopeId","data-v-fe3971bf"]]);export{Me as default};
